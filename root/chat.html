<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket èŠå¤©å®¤ Demo</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    #chat { width: 100%; height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    #msgInput { width: 80%; padding: 5px; }
    button { padding: 5px 10px; margin-left: 5px; }
    #header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="header">
    <h2>å¤šäººèŠå¤©å®¤ Demo</h2>
    <button id="logoutBtn">ç™»å‡º</button>
  </div>

  <div>
    ç”¨æˆ·åï¼š<input id="username" placeholder="è¾“å…¥ç”¨æˆ·å">
    æˆ¿é—´åï¼š<input id="room" value="room1">
    <button onclick="joinRoom()">è¿›å…¥æˆ¿é—´</button>
    <button onclick="leaveRoom()">é€€å‡ºæˆ¿é—´</button>
  </div>

  <div id="chat"></div>

  <input id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
  <button onclick="sendMessage()">å‘é€</button>

  <script>
    let ws = null;
    let username = '';
    let room = '';

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨éªŒè¯ç™»å½•çŠ¶æ€
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch("/api/auth/validate_session", { credentials: "include" });
        const data = await res.json();
        if (data.status !== "ok") {
          alert("è¯·å…ˆç™»å½•ï¼");
          window.location.href = "login.html";
          return;
        }
        username = data.username; // ä» session è¯»å–ç”¨æˆ·å
        document.getElementById("username").value = username;
        log(`ğŸ‘‹ æ¬¢è¿å›æ¥, ${username}`);
      } catch (e) {
        alert("æ— æ³•éªŒè¯ç™»å½•çŠ¶æ€ï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
        window.location.href = "login.html";
      }
    });

    // ç™»å‡ºé€»è¾‘
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        const res = await fetch("/api/auth/logout", {
          credentials: "include",
        });
        const data = await res.json();
        if (data.status === "ok") {
          alert("å·²ç™»å‡º");
          localStorage.removeItem("sessionId");
          window.location.href = "login.html";
        } else {
          alert("ç™»å‡ºå¤±è´¥: " + data.msg);
        }
      } catch (err) {
        alert("è¯·æ±‚é”™è¯¯: " + err);
      }
    });

    function log(msg) {
      const chat = document.getElementById('chat');
      chat.innerHTML += msg + '<br>';
      chat.scrollTop = chat.scrollHeight;
    }

    function joinRoom() {
      username = document.getElementById('username').value.trim();
      room = document.getElementById('room').value.trim();
      if (!username || !room) {
        alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œæˆ¿é—´å");
        return;
      }
      if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
        log("âš ï¸ å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ä¸è¦é‡å¤è¿›å…¥æˆ¿é—´");
        return;
      }
      ws = new WebSocket("ws://localhost:8080/api/upgrade");

      ws.onopen = () => {
        log("âœ… å·²è¿æ¥æœåŠ¡å™¨");

        // ç¬¬ä¸€æ­¥ï¼šå»¶è¿Ÿ 100ms å‘é€è®¤è¯æ¶ˆæ¯
        setTimeout(() => {
          ws.send(JSON.stringify({
            type: "auth",
            sessionid: localStorage.getItem("sessionId")
          }));

          // ç¬¬äºŒæ­¥ï¼šå†å»¶è¿Ÿ 100ms å‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
          setTimeout(() => {
            const joinMsg = {
              type: "room",
              action: "join",
              room: room,
              from: username,
              ts: Date.now()
            };
            ws.send(JSON.stringify(joinMsg));
          }, 100);

        }, 100);
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "chat" && msg.subtype === "room_msg") {
          log(`[${msg.room}] ${msg.from}: ${msg.content}`);
        } else if (msg.type === "system") {
          log(`ğŸ“¢ ç³»ç»Ÿ: ${msg.content}`);
        }
      };

      ws.onclose = () => log("âŒ è¿æ¥å·²å…³é—­");
      ws.onerror = (err) => log("âš ï¸ è¿æ¥å‡ºé”™: " + err);
    }

    function sendMessage() {
      const input = document.getElementById('msgInput');
      const content = input.value.trim();
      if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;

      const msg = {
        type: "chat",
        subtype: "room_msg",
        from: username,
        room: room,
        content: content,
        ts: Date.now()
      };
      ws.send(JSON.stringify(msg));
      input.value = '';
    }

    function leaveRoom() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const msg = {
          type: "room",
          action: "leave",
          room: room,
          from: username,
          ts: Date.now()
        };
        ws.send(JSON.stringify(msg));
        ws.close();
      }
      log(`ğŸšª å·²é€€å‡ºæˆ¿é—´ ${room}`);
    }
  </script>
</body>
</html>
